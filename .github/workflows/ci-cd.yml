name: CI/CD Pipeline

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # BUILD PHASE (Your existing CI)
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: yarn
          cache-dependency-path: client/yarn.lock
          
      - name: Install dependencies
        run: yarn install --frozen-lockfile
        working-directory: client
      
      - name: Build project
        run: yarn build
        working-directory: client

      # Verify build output
      - name: Verify build output
        run: |
          echo "ðŸ“ Checking if Sidebar.html was generated..."
          if [ -f "Sidebar.html" ]; then
            echo "âœ… Sidebar.html found!"
            ls -la Sidebar.html
          else
            echo "âŒ Sidebar.html not found! Build might have failed."
            echo "Current directory contents:"
            ls -la
            exit 1
          fi

      # DEPLOY PHASE (Only on push to main, not on PRs)
      - name: Install Clasp
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: 
          npm install -g @google/clasp
          
      - name: Create .clasp.json
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          cat > .clasp.json << 'EOF'
          {
            "scriptId": "${{secrets.SCRIPT_ID}}",
            "rootDir": "",
            "scriptExtensions": [
              ".js",
              ".gs"
            ],
            "htmlExtensions": [
              ".html"
            ],
            "jsonExtensions": [
              ".json"
            ],
            "filePushOrder": [],
            "skipSubdirectories": false
          }
          EOF
          echo ".clasp.json created"

      - name: Create .claspignore
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          cat > .claspignore << 'EOF'
          **/**
          !Code.js
          !Sidebar.html
          !appsscript.json
          EOF
          echo "âœ… .claspignore created"
          cat .claspignore

      - name: Create .clasprc.json
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: echo '${{secrets.CLASP_CREDENTIALS}}' > ~/.clasprc.json

      - name: Push the code
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: clasp push --force
